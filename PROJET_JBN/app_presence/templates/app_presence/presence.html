<!-- app_presence/templates/app_presence/presence.html -->
{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presence</title>
    <link rel="icon" type="image/png" href="{% static 'icone/CBA.png' %}">
     <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css    " rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css    " rel="stylesheet">
  <!-- CSS Custom -->
     <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css    ' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css    ">
    <link rel="stylesheet" href="{% static 'app_presence/css/pre.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js    "></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   

</head>
<body>

    <div class="sidebar">
       <div class="logo">
     <img src="{% static '/icone/CBA.png' %}" alt="Logo SGCBA" class="logo-img">  
    <span>SGCBA</span>
</div>

       <nav>
  <ul>
    <li id="menu-dashboard"><a href="{% url 'tableau_de_bord' %}"><i class="fas fa-th-large"></i>TABLEAU DE BORD</a></li>
    <li id="menu-inscription"><a href="{% url 'inscription' %}"><i class="fa-solid fa-notes-medical"></i> Inscription</a></li>
    <li id="menu-eleve"><a href="{% url 'eleve' %}"><i class="fa-solid fa-user-tie"></i> Eleve</a></li>
    <li id="menu-presence"><a href="{% url 'presence' %}"class="active"><i class="fas fa-chalkboard-teacher"></i> Presence</a></li>
    <li id="menu-note"><a href="{% url 'note' %}"><i class='bx bx-note'></i> Note</a></li>
    <li id="menu-bulletin"><a href="{% url 'bulletin' %}"><i class="fa-solid fa-square-poll-horizontal"></i> Bulletin</a></li>
     <li id="menu-classe"><a href="{% url 'classe' %}"><i class="fa-solid fa-square-poll-horizontal"></i> Classe</a></li>
    <li id="menu-utilisateur"><a href="{% url 'utilisateurs' %}"><i class="fa-solid fa-user"></i> Utilisateur</a></li>
    <li id="menu-parametre"><a href="{% url 'parametre' %}"><i class="fa-solid fa-gear"></i> Parametres</a></li>
  </ul>
</nav>
       
    </div>

    <div class="main-content">
        <div class="header">
            <h1>PRESENCE</h1>
            <div class="search-profile">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                   <input id="searchPresence" type="text" placeholder="Rechercher...">

                </div>
               <div class="profile">
    <!-- Cloche avec badge -->
    <div class="position-relative d-inline-block me-3">
        <i class="fas fa-bell notification-icon" id="notificationBell" style="cursor:pointer;"></i>
        <span id="notificationBadge" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" style="display:none; font-size:0.7em;">0</span>
    </div>

    <!-- Avatar utilisateur -->
    <div class="user-avatar" id="profileDropdownToggle">
       <img src="{{ user_photo|default:'/static/image/pro.png' }}" alt="Profil">
    </div>

    <!-- Dropdown des notifications -->
    <div class="notification-dropdown" id="notificationDropdown" style="display:none;">
        <ul id="notificationList">
            <li>Aucune notification</li>
        </ul>
    </div>

    <!-- Dropdown menu profil -->
    <div class="profile-dropdown" id="profileDropdown">
        <ul>
            <li><a href="{% url 'logout' %}">D√©connecter</a></li>
        </ul>
    </div>
</div>
</div>
</div>





<!-- Bouton pour ouvrir la modale -->
<button id="openQRModalBtn" class="btn btn-info">G√©n√©rer QR de Pr√©sence</button>

<!-- Modale pour choisir la classe -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrModalLabel">Choisir la classe</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <select id="classeSelect" class="form-select">
          <option value="">S√©lectionnez une classe...</option>
          {% for classe in classes %}
            <option value="{{ classe.id }}">{{ classe.nom_classe }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button id="generateQRBtn" class="btn btn-primary">G√©n√©rer QR</button>
      </div>
    </div>
  </div>
</div>

<!-- Conteneur pour afficher le QR g√©n√©r√© -->
<div id="qrcode-container" class="mt-3 text-center" style="display:none;">
  <h4>QR pour la classe : <span id="selectedClassName"></span></h4>
  <div id="qrcode-display"></div>
  <button id="printQRBtn" class="btn btn-success mt-2">Imprimer QR</button>
</div>





  
{% comment %} intefas pwezans an {% endcomment %}
  <div class="container">
    {% comment %} <h2 class="text-center mb-4">PRESENCE</h2> {% endcomment %}

    <!-- Bouton Ajouter -->
    <div class="mb-3 text-end">
      <button id="btnShowForm" class="btn btn-primary btn-custom">Ajouter Presence</button>
    </div>
 

    <!-- Formulaire (modal) -->
    <div id="formModal" class="modal-overlay">
      <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <h4 class="mb-3">Ajouter une presence</h4>
       <form id="presenceForm">  <!-- ‚úÖ Nouvo ID pou form la -->
  {% csrf_token %} <!-- ‚úÖ CSRF token -->
  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Code de l'eleve</label>
      <input type="text" name="code_eleve" id="code_eleve" class="form-control" placeholder="Code" required> <!-- ‚úÖ Ajoute 'name' -->
    </div>
    
    <div class="col-md-4">
      <label class="form-label">Nom</label>
      <input type="text" name="nom" id="nom_eleve" class="form-control" placeholder="Nom" readonly>  <!-- ‚úÖ Ajoute 'name' -->
    </div>

    <div class="col-md-4">
      <label class="form-label">Pr√©nom</label>
      <input type="text" name="prenom" id="prenom_eleve" class="form-control" placeholder="Pr√©nom" readonly>  <!-- ‚úÖ Ajoute 'name' -->
    </div>

     <div class="col-md-4">
      <label class="form-label">Classe</label>
      <input type="text" name="classe" id="classe_eleve" class="form-control" placeholder="Classe" readonly>  <!-- ‚úÖ Ajoute 'name' -->
    </div>

     <div class="col-md-4">
      <label class="form-label">Date presence</label>
      <input type="date" name="date_presence" id="date_presence" class="form-control" required> <!-- ‚úÖ Ajoute 'name' -->
    </div>
  </div>

  <div class="text-end">
    <button type="submit" class="btn btn-custom btn-ajouter">Ajouter</button>
    {% comment %} <button type="submit" class="btn btn-success btn-custom">Ajouter</button> {% endcomment %}
    <button type="button" id="cancelForm" class="btn btn-secondary btn-custom">Fermer</button>
  </div>
</form>
      </div>
    </div>

    <!-- Options affichage -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <label>Afficher 
          <select class="form-select d-inline w-auto">
            <option>10</option>
            <option>25</option>
            <option>50</option>
          </select> 
          Presence
        </label>
      </div>
    </div>
  <br>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-striped" id="tableEleves">
       <thead class="table-header-blue">
          <tr>
            <th>Code</th>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th>Classe</th>
             <th>Statut</th>
            <th>Date Presence</th>
          </tr>
        </thead>
        <tbody>
          {% for p in presences %}
          <tr>
            <td>{{ p.eleve.code_eleve }}</td>
            <td>{{ p.eleve.nom }}</td>
            <td>{{ p.eleve.prenom }}</td>
           <td>
  {% if p.klas %}
    {{ p.klas.nom_classe }}
  {% else %}
    N/A
  {% endif %}
</td>
 <td>{{ p.statut }}</td>
            <td>{{ p.date }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>




  

  <!--lien paj javascrip-->
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 2. QRCode.js (n√©cessaire pour g√©n√©rer le QR) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Script Custom -->
 <script src="{% static 'app_presence/js/presen.js' %}"></script>
 <script src="{% static 'js/charts.js' %}"></script>
 <script src="{% static 'js/role-control.js' %}"></script>


<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('üü¢ Script charg√©');

    const openQRModalBtn = document.getElementById('openQRModalBtn');
    const qrModalElement = document.getElementById('qrModal');
    const generateQRBtn = document.getElementById('generateQRBtn');
    const classeSelect = document.getElementById('classeSelect');
    const qrContainer = document.getElementById('qrcode-container');
    const selectedClassName = document.getElementById('selectedClassName');
    const qrDisplay = document.getElementById('qrcode-display');
    const printQRBtn = document.getElementById('printQRBtn');

    // V√©rifier que Bootstrap Modal est disponible
    if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap n\'est pas charg√© !');
        return;
    }

    const qrModal = new bootstrap.Modal(qrModalElement);

    // Ouvrir la modale
    openQRModalBtn.addEventListener('click', () => {
        console.log('üîµ Bouton "G√©n√©rer QR" cliqu√©');
        qrModal.show();
    });

    // G√©n√©rer le QR
    generateQRBtn.addEventListener('click', async () => {
        const classeId = classeSelect.value;
        console.log('üîµ Classe s√©lectionn√©e:', classeId);

        if (!classeId) {
            alert('Veuillez s√©lectionner une classe.');
            return;
        }

        try {
            qrModal.hide();
            console.log('‚è≥ Requ√™te en cours...');

            const response = await fetch(`/presence/generate-qr-permanent/${classeId}/`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            const data = await response.json();
            console.log('üì¶ R√©ponse re√ßue:', data);

            if (data.success) {
                selectedClassName.textContent = data.classe_nom;
                qrDisplay.innerHTML = '';
                qrContainer.style.display = 'block';

                // V√©rifier que QRCode est disponible
                if (typeof QRCode === 'undefined') {
                    console.error('‚ùå QRCode.js n\'est pas charg√© !');
                    alert('Erreur : QRCode.js non charg√©');
                    return;
                }

                console.log('‚úÖ G√©n√©ration du QR Code');
                new QRCode(qrDisplay, {
                    text: data.qr_url,
                    width: 250,
                    height: 250
                });

                printQRBtn.onclick = () => window.print();
            } else {
                alert('Erreur: ' + data.error);
            }
        } catch (error) {
            console.error('‚ùå Erreur:', error);
            alert('Erreur r√©seau ou serveur.');
        }
    });
});
</script>



</body>
</html>