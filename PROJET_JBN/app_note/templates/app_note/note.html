{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Notes</title>
<link rel="icon" type="image/png" href="{% static 'icone/CBA.png' %}">
 <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css  ' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css  ">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css  " rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css  " rel="stylesheet">
 <link rel="stylesheet" href="{% static 'app_note/css/note.css' %}">
<script src="{% static 'js/role-control.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11  "></script>
   
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
   <div class="logo">
     <img src="{% static '/icone/CBA.png' %}" alt="Logo SGCBA" class="logo-img">  
     <span>SGCBA</span>
   </div>
  <nav>
  <ul>
    <li id="menu-dashboard"><a href="{% url 'tableau_de_bord' %}"><i class="fas fa-th-large"></i>TABLEAU DE BORD</a></li>
    <li id="menu-inscription"><a href="{% url 'inscription' %}"><i class="fa-solid fa-notes-medical"></i> Inscription</a></li>
    <li id="menu-eleve"><a href="{% url 'eleve' %}"><i class="fa-solid fa-user-tie"></i> Eleve</a></li>
    <li id="menu-presence"><a href="{% url 'presence' %}"><i class="fas fa-chalkboard-teacher"></i> Presence</a></li>
    <li id="menu-note"><a href="{% url 'note' %}"class="active"><i class='bx bx-note'></i> Note</a></li>
    <li id="menu-bulletin"><a href="{% url 'bulletin' %}"><i class="fa-solid fa-square-poll-horizontal"></i> Bulletin</a></li>
     <li id="menu-classe"><a href="{% url 'classe' %}"><i class="fa-solid fa-square-poll-horizontal"></i> Classe</a></li>
    <li id="menu-utilisateur"><a href="{% url 'utilisateurs' %}"><i class="fa-solid fa-user"></i> Utilisateur</a></li>
    <li id="menu-parametre"><a href="{% url 'parametre' %}"><i class="fa-solid fa-gear"></i> Parametres</a></li>
  </ul>
</nav>
</div>

<!-- Main content -->
<div class="main-content">
    <div class="header d-flex justify-content-between align-items-center">
        <h1>GESTION NOTES</h1>
        <div class="d-flex align-items-center">
           <div class="search-bar me-3">
    <i class="fas fa-search"></i>
    <input 
        type="text" 
        id="searchNotesInput" 
        placeholder="Rechercher Inscription, √âl√®ves, Pre...">
</div>
            <div class="profile position-relative">
                <i class="fas fa-bell notification-icon me-2"></i>
                <div class="user-avatar" id="profileDropdownToggle" style="cursor:pointer;">
                    <img src="{{ user_photo|default:'/static/image/pro.png' }}" alt="Profil">
                </div>
                <!-- Dropdown menu -->
                 <!-- Dropdown menu -->
    <div class="profile-dropdown" id="profileDropdown">
        <ul>
            <li><a href="{% url 'logout' %}">D√©connecter</a></li>
        </ul>
    </div>
</div>
 </div>
        </div>

    <div class="container mt-4">
      <!-- Bouton Ajouter -->
      <div class="mb-3 text-end">
        <button id="btnShowForm" class="btn btn-primary btn-custom">Ajouter</button>
      </div>

      <!-- Modal -->
      <div id="formModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
          <span id="closeModal" class="close">&times;</span>
          <h4 class="mb-3">Gestion Notes</h4>

          

          <!-- Step 1: Code √©l√®ve (MODIFYE) -->
<div id="step1" class="text-center mb-4">
  <label class="form-label" style="font-weight: 500; color: #495057;">Code √©l√®ve</label>
  <div class="d-flex justify-content-center mt-2">
    <input type="text" id="inputCodeEleve" class="form-control" placeholder="Entrer le code de l'√©l√®ve" style="max-width: 300px;">
  </div>
  <button id="btnVerifyCode" class="btn btn-primary mt-3" style="padding: 0.5rem 1.5rem;">V√©rifier et Ajouter</button>
  <div id="codeError" class="text-danger mt-2" style="display:none;">√âl√®ve non trouv√©.</div>
</div>

          <!-- Step 2: Formulaire note -->
          <div id="step2" style="display:none;text-align: center;">
            <p><strong>Nom:</strong> <span id="nomEleve"></span></p>
            <p><strong>Pr√©nom:</strong> <span id="prenomEleve"></span></p>
            <p><strong>Classe:</strong> <span id="classeEleve"></span></p>

            <form id="formNotes">
              <div id="notesFields">
                <!-- 2 lignes mati√®res/note par d√©faut g√©n√©r√©es par JS -->
              </div>
              <div class="d-flex justify-content-between mt-3">
  <button type="button" id="addNoteRow" class="btn btn-secondary">Ajouter Mati√®re</button>
  <button type="submit" class="btn btn-primary">Enregistrer</button>
</div>
            </form>

            <div id="successMessage" class="alert alert-success mt-3">Notes enregistr√©es avec succ√®s !</div>
          </div>

          <button type="button" id="cancelForm" class="btn btn-secondary mt-3">Fermer</button>
        </div>
      </div>
      
<!-- Dans note.html -->
{% if request.session.role == 'directeur' %}
  <div style="position: fixed; top: 550px; right: 13%; z-index: 9999; font-size: 16px; padding: 10px;">
    <a href="{% url 'gestion_matieres' %}" 
       style="background: #0d6efd; color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
      üîß Mati√®res (Directeur)
    </a>
  </div>
{% endif %}
  <!-- Modal pour afficher les notes d√©taill√©es -->
<div id="notesModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
  <div style="background:white; margin:50px auto; padding:20px; width:90%; max-width:500px; border-radius:8px;">
    <h5>Notes de <span id="modalEleveNom"></span></h5>
    <ul id="modalNotesList" style="list-style:none; padding:0;"></ul>
    <button id="closeNotesModal" class="btn btn-secondary mt-2">Fermer</button>
  </div>
</div>


       <!-- Options affichage -->
  
   <h4 style="text-align: center;" >Liste des notes</h4>
      <!-- Table Eleves -->
      <div class="table-responsive mt-4">
        <table class="table table-bordered table-striped" id="tableEleves">
        <thead class="table-header-blue">
  <tr>
    <th>Code</th>
    <th>Nom</th>
    <th>Pr√©nom</th>
    <th>Classe</th>
     <th>P√©riode</th>
    <th>Notes</th>
    
    <th>Action</th>
  </tr>
</thead>
         <tbody id="tableElevesBody">
  <!-- Les notes seront ins√©r√©es ici par JS -->
</tbody>
        </table>
      </div>
    </div>
</div>

  <!-- Modal pour √©diter les notes -->
<div id="editNotesModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001;">
  <div style="background:white; margin:50px auto; padding:20px; width:90%; max-width:600px; border-radius:8px;">
    <h5>Modifier les notes de <span id="editModalEleveNom"></span></h5>
    <form id="editFormNotes">
      <div id="editNotesFields">
        <!-- Les champs seront ins√©r√©s ici dynamiquement -->
      </div>
      {% comment %} <button type="button" id="addEditNoteRow" class="btn btn-secondary mb-2">Ajouter Mati√®re</button> {% endcomment %}
      <button type="submit" class="btn btn-success">Enregistrer Modifications</button>
      <button type="button" id="closeEditModal" class="btn btn-secondary ms-2">Fermer</button>
    </form>
  </div>
</div>
<!-- ... (reste du HTML inchang√©) ... -->

<script>
    // === Fonction pour obtenir le cookie CSRF ===
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // === Charger les mati√®res ===
    let matieresList = [];
    fetch('/note/api/matieres/')
        .then(res => res.json())
        .then(data => {
            matieresList = data;
        })
        .catch(err => console.error("Erreur chargement mati√®res:", err));

    document.addEventListener('DOMContentLoaded', () => {
        let inactivityTimer;

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                fetch('/api/logout/', {
                    method: 'GET',
                    credentials: 'same-origin'
                }).finally(() => {
                    // ‚úÖ Remplace alert() par SweetAlert2
                    Swal.fire({
                        title: 'Session expir√©e',
                        text: 'Vous avez √©t√© d√©connect√© automatiquement pour inactivit√©.',
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    }).then(() => {
                        window.location.href = '/connexion/';
                    });
                });
            }, 2 * 60 * 1000); // 2 minutes d'inactivit√©
        }

        resetInactivityTimer();

        window.addEventListener('mousemove', resetInactivityTimer);
        window.addEventListener('keydown', resetInactivityTimer);
        window.addEventListener('scroll', resetInactivityTimer);
        window.addEventListener('click', resetInactivityTimer);

        // === Recherche en temps r√©el ===
        const searchInput = document.getElementById('searchNotesInput');
        const tbody = document.getElementById('tableElevesBody');

        if (searchInput && tbody) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                let visibleCount = 0;

                // Parcourir chaque ligne du tableau
                Array.from(tbody.rows).forEach(row => {
                    const text = row.textContent.toLowerCase();
                    
                    if (searchTerm === '' || text.includes(searchTerm)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // G√©rer le message "Aucun r√©sultat"
                const noResultRow = document.getElementById('no-result-row');
                if (searchTerm !== '' && visibleCount === 0) {
                    if (!noResultRow) {
                        const newRow = document.createElement('tr');
                        newRow.id = 'no-result-row';
                        // ‚ö†Ô∏è 7 colonnes ‚Üí colspan="7"
                        newRow.innerHTML = `<td colspan="7" class="text-center text-muted">Aucun r√©sultat trouv√©</td>`;
                        tbody.appendChild(newRow);
                    }
                } else if (noResultRow) {
                    noResultRow.remove();
                }
            });
        }

        const toggle = document.getElementById('profileDropdownToggle');
        const dropdown = document.getElementById('profileDropdown');

        if (toggle && dropdown) {
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', () => {
                dropdown.style.display = 'none';
            });

            dropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            const logoutLink = dropdown.querySelector("a");
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    Swal.fire({
                      title: 'D√©connexion',
                      text: "√ätes-vous s√ªr de vouloir d√©connecter ?",
                      icon: 'warning',
                      showCancelButton: true,
                      confirmButtonText: 'Oui',
                      cancelButtonText: 'Non'
                    }).then((result) => {
                      if (result.isConfirmed) {
                        window.location.href = this.href;
                      }
                    });
                });
            }
        }

        // === Modal gestion notes ===
        const btnShowForm = document.getElementById('btnShowForm');
        const formModal = document.getElementById('formModal');
        const closeModal = document.getElementById('closeModal');
        const cancelForm = document.getElementById('cancelForm');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const inputCodeEleve = document.getElementById('inputCodeEleve');
        const btnVerifyCode = document.getElementById('btnVerifyCode');
        const codeError = document.getElementById('codeError');
        const nomEleve = document.getElementById('nomEleve');
        const prenomEleve = document.getElementById('prenomEleve');
        const classeEleve = document.getElementById('classeEleve');
        const notesFields = document.getElementById('notesFields');
        const addNoteRow = document.getElementById('addNoteRow');
        const successMessage = document.getElementById('successMessage');

        let currentCodeEleve = null;

        function createNoteRow(matiereId = '', noteValue = '') {
            const div = document.createElement('div');
            div.classList.add('row', 'g-2', 'mb-2', 'noteRow');
            const options = matieresList.map(m =>
                `<option value="${m.id}" ${m.id == matiereId ? 'selected' : ''}>${m.nom}</option>`
            ).join('');
            div.innerHTML = `
                <div class="col">
                    <select class="form-select" required>
                        <option value="">Choisir mati√®re</option>
                        ${options}
                    </select>
                </div>
                <div class="col">
                    <input type="number" class="form-control" step="0.01" min="0" max="100" value="${noteValue}" placeholder="Note" required>
                </div>
                <div class="col-auto d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-row">‚úï</button>
                </div>
            `;
            notesFields.appendChild(div);

            div.querySelector('.remove-row').addEventListener('click', () => div.remove());
        }

        btnShowForm.addEventListener('click', () => {
            formModal.style.display = 'flex';
            step1.style.display = 'block';
            step2.style.display = 'none';
            codeError.style.display = 'none';
            inputCodeEleve.value = '';
            successMessage.style.display = 'none';
            notesFields.innerHTML = '';
            createNoteRow();
            createNoteRow();
        });

        [closeModal, cancelForm].forEach(btn => {
            btn.addEventListener('click', () => formModal.style.display = 'none');
        });

        btnVerifyCode.addEventListener('click', async () => {
            const code = inputCodeEleve.value.trim();
            if (!code) {
                codeError.style.display = 'block';
                codeError.textContent = 'Veuillez entrer un code.';
                return;
            }

            try {
                const res = await fetch('/note/api/verifier-eleve/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `code=${encodeURIComponent(code)}`
                });
                const data = await res.json();

                if (data.existe) {
                    codeError.style.display = 'none';
                    step1.style.display = 'none';
                    step2.style.display = 'block';
                    nomEleve.textContent = data.nom;
                    prenomEleve.textContent = data.prenom;
                    classeEleve.textContent = data.classe;
                    currentCodeEleve = code;
                } else {
                    codeError.style.display = 'block';
                    codeError.textContent = '√âl√®ve non trouv√© ou non valid√©.';
                    step2.style.display = 'none';
                }
            } catch (e) {
                alert('Erreur de connexion au serveur.');
            }
        });

        addNoteRow.addEventListener('click', () => createNoteRow());

        // Soumission des notes
        const formNotes = document.getElementById('formNotes');
        if (formNotes) {
            formNotes.addEventListener('submit', async (e) => {
                e.preventDefault();
                const rows = notesFields.querySelectorAll('.noteRow');
                const notes = [];

                for (const row of rows) {
                    const select = row.querySelector('select');
                    const input = row.querySelector('input');
                    if (!select.value || !input.value) continue;
                    notes.push({
                        matiere_id: select.value,
                        valeur: parseFloat(input.value)
                    });
                }

               if (notes.length === 0) {
    Swal.fire({
        title: 'Erreur',
        text: 'Veuillez entrer au moins une note.',
        icon: 'warning',
        confirmButtonText: 'OK',
        confirmButtonColor: '#0d6efd'
    });
    return;
}

                try {
                    const response = await fetch('/note/api/enregistrer-notes/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            code_eleve: currentCodeEleve,
                            notes: notes
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        successMessage.style.display = 'block';
                        setTimeout(() => formModal.style.display = 'none', 2000);
                         chargerNotes();
                    } else {
                        alert('Erreur : ' + (result.erreur || '√âchec'));
                    }
                } catch (e) {
                    alert('Erreur r√©seau : ' + e.message);
                }
            });
        }

        // === Fonction pour attacher les √©v√©nements de suppression ===
        function attacherEcouteursSuppression() {
            document.querySelectorAll('.delete-note').forEach(button => {
                button.addEventListener('click', function () {
                    const codeEleve = this.dataset.code;
                    console.log("Bouton Supprimer cliqu√© pour code:", codeEleve); // ‚úÖ Debug

                    Swal.fire({
                        title: 'Supprimer les notes ?',
                        text: "Cette action supprimera toutes les notes de cet √©l√®ve pour le trimestre en cours. √ätes-vous s√ªr ?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Oui, supprimer',
                        cancelButtonText: 'Annuler',
                        confirmButtonColor: '#d33'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const token = getCookie('csrftoken');
                            console.log("CSRF Token (suppression):", token); // ‚úÖ Debug
                            if (!token) {
                                alert("Erreur CSRF token manquant.");
                                return;
                            }

                            fetch(`/note/api/supprimer-notes/${encodeURIComponent(codeEleve)}/`, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': token
                                }
                            })
                            .then(res => {
                                console.log("R√©ponse suppression:", res.status); // ‚úÖ Debug
                                return res.json();
                            })
                            .then(data => {
                                if (data.success) {
                                    Swal.fire('Supprim√© !', data.message || 'Notes supprim√©es.', 'success');
                                    chargerNotes(); // Recharger le tableau
                                } else {
                                    Swal.fire('Erreur', data.erreur || 'Impossible de supprimer.', 'error');
                                }
                            })
                            .catch(err => {
                                console.error("Erreur suppression:", err);
                                Swal.fire('Erreur', 'Erreur r√©seau ou serveur.', 'error');
                            });
                        }
                    });
                });
            });
        }

        // === Fonction pour cr√©er une ligne de note √©ditable ===
        function createEditNoteRow(matiereId = '', noteValue = '', nomMatiere = '') {
            const div = document.createElement('div');
            div.classList.add('row', 'g-2', 'mb-2', 'editNoteRow');
            let options = matieresList.map(m =>
                `<option value="${m.id}" ${m.id == matiereId ? 'selected' : ''}>${m.nom}</option>`
            ).join('');
            if (!matiereId && nomMatiere) {
                options = `<option value="" selected disabled>${nomMatiere}</option>` + options;
            }
            div.innerHTML = `
                <div class="col">
                    <select class="form-select" required>
                        <option value="">Choisir mati√®re</option>
                        ${options}
                    </select>
                </div>
                <div class="col">
                    <input type="number" class="form-control" step="0.01" min="0" max="100" value="${noteValue}" placeholder="Note" required>
                </div>
                <div class="col-auto d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-edit-row">‚úï</button>
                </div>
            `;
            document.getElementById('editNotesFields').appendChild(div);

            div.querySelector('.remove-edit-row').addEventListener('click', () => div.remove());
        }

        // === Fonction pour ouvrir le modal d‚Äô√©dition ===
        function ouvrirModalEdition(codeEleve, nom, prenom, classe, notes) { // ‚úÖ Retir√© "periode"
            const modal = document.getElementById('editNotesModal');
            const nomSpan = document.getElementById('editModalEleveNom');
            const form = document.getElementById('editFormNotes');
            const fieldsDiv = document.getElementById('editNotesFields');

            nomSpan.textContent = `${prenom} ${nom}`;
            fieldsDiv.innerHTML = '';

            // Remplir les lignes avec les notes existantes
            notes.forEach(n => {
                const matiere = matieresList.find(m => m.nom === n.matiere);
                const matiereId = matiere ? matiere.id : '';
                createEditNoteRow(matiereId, n.valeur, n.matiere);
            });

            if (notes.length === 0) {
                createEditNoteRow();
            }

            modal.style.display = 'block';

            document.getElementById('closeEditModal').addEventListener('click', () => {
                modal.style.display = 'none';
            });

            form.onsubmit = async (e) => {
                e.preventDefault();
                console.log("Formulaire de modification soumis"); // ‚úÖ Debug
                const rows = fieldsDiv.querySelectorAll('.editNoteRow');
                const nouvellesNotes = [];

                for (const row of rows) {
                    const select = row.querySelector('select');
                    const input = row.querySelector('input');
                    if (!select.value || !input.value) continue;
                    nouvellesNotes.push({
                        matiere_id: select.value,
                        valeur: parseFloat(input.value)
                    });
                }

                if (nouvellesNotes.length === 0) {
                    alert('Veuillez entrer au moins une note.');
                    return;
                }

                const token = getCookie('csrftoken');
                console.log("CSRF Token (modif):", token); // ‚úÖ Debug
                if (!token) {
                    alert("Erreur CSRF token manquant.");
                    return;
                }

                try {
                    const response = await fetch('/note/api/modifier-notes/', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': token
                        },
                        body: JSON.stringify({
                            code_eleve: codeEleve,
                            notes: nouvellesNotes
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        Swal.fire('Modifi√© !', result.message || 'Notes mises √† jour.', 'success');
                        modal.style.display = 'none';
                        chargerNotes(); // Recharger le tableau
                    } else {
                        alert('Erreur : ' + (result.erreur || '√âchec'));
                    }
                } catch (e) {
                    console.error("Erreur modification:", e);
                    alert('Erreur r√©seau : ' + e.message);
                }
            };
        }

        // === Charger et afficher les notes ===
        function chargerNotes() {
            const tbody = document.getElementById('tableElevesBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Chargement...</td></tr>'; // ‚úÖ Mis √† jour en 7

            fetch('/note/api/notes/')
                .then(res => res.json())
                .then(eleves => {
                    if (eleves.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune note enregistr√©e.</td></tr>'; // ‚úÖ Mis √† jour en 7
                        return;
                    }

                    tbody.innerHTML = '';
                    eleves.forEach(el => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${el.code_eleve}</td>
                            <td>${el.nom}</td>
                            <td>${el.prenom}</td>
                            <td>${el.classe}</td>
                            <td>${el.periode}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info show-notes" data-notes='${JSON.stringify(el.matieres_notes)}'>
                                    üëÅÔ∏è Voir notes
                                </button>
                            </td>
                            <td>
                               <div class="d-flex gap-1">
        <button class="btn btn-warning btn-sm edit-note" data-code="${el.code_eleve}">
            <i class="bi bi-pencil"></i>
        </button>
        <button class="btn btn-danger btn-sm delete-note" data-code="${el.code_eleve}">
            <i class="bi bi-trash"></i>
        </button>
    </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Attacher les √©v√©nements suppression et modification
                    attacherEcouteursSuppression();

                    document.querySelectorAll('.edit-note').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const codeEleve = this.dataset.code;
                            console.log("Bouton Modifier cliqu√© pour code:", codeEleve); // ‚úÖ Debug

                            const row = this.closest('tr');
                            const nom = row.children[1].textContent;
                            const prenom = row.children[2].textContent;
                            const classe = row.children[3].textContent;

                            const showBtn = row.querySelector('.show-notes');
                            const notes = JSON.parse(showBtn.dataset.notes);

                            ouvrirModalEdition(codeEleve, nom, prenom, classe, notes); // ‚úÖ Retir√© "periode"
                        });
                    });

                    // Bouton "Voir notes"
                    document.querySelectorAll('.show-notes').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const notes = JSON.parse(this.dataset.notes);
                            const modal = document.getElementById('notesModal');
                            const list = document.getElementById('modalNotesList');
                            const nomSpan = document.getElementById('modalEleveNom');

                            const row = this.closest('tr');
                            const nom = row.children[1].textContent;
                            const prenom = row.children[2].textContent;
                            nomSpan.textContent = `${prenom} ${nom}`;

                            list.innerHTML = '';
                            notes.forEach(n => {
                                const li = document.createElement('li');
                                li.innerHTML = `<strong>${n.matiere}:</strong> ${n.valeur}`;
                                list.appendChild(li);
                            });

                            modal.style.display = 'block';
                        });
                    });

                    document.getElementById('closeNotesModal').addEventListener('click', () => {
                        document.getElementById('notesModal').style.display = 'none';
                    });
                })
                .catch(err => {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erreur de chargement.</td></tr>'; // ‚úÖ Mis √† jour en 7
                    console.error("Erreur chargement tableau:", err);
                });
        }

        // === Charger les notes au d√©marrage ===
        chargerNotes();
    });
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js    "></script>
<!-- Supprim√© : <script src="{% static 'app_note/js/notes.js' %}"></script> -->
</body>
</html>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js  "></script>
<!-- Supprim√© : <script src="{% static 'app_note/js/notes.js' %}"></script> -->
</body>
</html>