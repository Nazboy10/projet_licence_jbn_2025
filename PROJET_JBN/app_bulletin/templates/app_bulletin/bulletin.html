{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="torrent-scale" content="width=device-width, initial-scale=1.0">
    <title>BULLETIN DU COLLEGE BELL ANGELOT (CBA)</title>
    <link rel="icon" type="image/png" href="{% static 'icone/CBA.png' %}">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'app_bulletin/css/bulle.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/role-control.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- ‚úÖ CSS pou enprime s√®lman bulletin an -->
    <style>
      @media print {
        body * {
          visibility: hidden;
        }
        #bulletinPrintArea, #bulletinPrintArea * {
          visibility: visible;
        }
        #bulletinPrintArea {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          padding: 20px;
          box-sizing: border-box;
        }
        .no-print {
          display: none !important;
        }
      }
    </style>
</head>
<body>

<div class="sidebar">
  <div class="logo">
    <img src="{% static '/icone/CBA.png' %}" alt="Logo SGCBA" class="logo-img">  
    <span>SGCBA</span>
  </div>
  <nav>
    <ul>
      <li id="menu-dashboard"><a href="{% url 'tableau_de_bord' %}"><i class="fas fa-th-large"></i>TABLEAU DE BORD</a></li>
      <li id="menu-inscription"><a href="{% url 'inscription' %}"><i class="fa-solid fa-notes-medical"></i> Inscription</a></li>
      <li id="menu-eleve"><a href="{% url 'eleve' %}"><i class="fa-solid fa-user-tie"></i> Eleve</a></li>
      <li id="menu-presence"><a href="{% url 'presence' %}"><i class="fas fa-chalkboard-teacher"></i> Presence</a></li>
      <li id="menu-note"><a href="{% url 'note' %}"><i class='bx bx-note'></i> Note</a></li>
      <li id="menu-bulletin"><a href="{% url 'bulletin' %}" class="active"><i class="fa-solid fa-square-poll-horizontal"></i> Bulletin</a></li>
      <li id="menu-classe"><a href="{% url 'classe' %}"><i class="fa-solid fa-square-poll-horizontal"></i> Classe</a></li>
      <li id="menu-utilisateur"><a href="{% url 'utilisateurs' %}"><i class="fa-solid fa-user"></i> Utilisateur</a></li>
      <li id="menu-parametre"><a href="{% url 'parametre' %}"><i class="fa-solid fa-gear"></i> Parametres</a></li>
    </ul>
  </nav>
</div>

<div style="display:none;">
  {% csrf_token %}
</div>

<div class="main-content">
  <div class="header">
    <h1>BULLETIN</h1>
    <div class="search-profile">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" id="searchBulletinInput" placeholder="Rechercher...">
      </div>
      <div class="profile">
        <i class="fas fa-bell notification-icon"></i>
        <div class="user-avatar" id="profileDropdownToggle">
          <img src="{{ user_photo|default:'/static/image/pro.png' }}" alt="Profil">
        </div>
        <div class="profile-dropdown" id="profileDropdown">
          <ul><li><a href="{% url 'logout' %}">D√©connecter</a></li></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ BTN "G√©n√©rer Bulletin" -->
  <div class="top-right no-print">
    <button id="btnAfficherFormulaire">G√©n√©rer Bulletin</button>
  </div>

  <h2 style="text-align: center;" class="no-print">La liste des Bulletins</h2>

  <div class="container">
    <!-- ‚úÖ F√íM POU ANTRE K√íD -->
    <div id="formulairePage" class="no-print" style="display:none; text-align:center; margin:20px;">
      <h4>Entrer le code de l'√©l√®ve</h4>
      <input type="text" id="inputCodeForm" placeholder="Ex: ELEVE123" style="padding:8px; margin:10px; width:250px;">
      <div>
        <button id="btnValiderForm" style="margin:5px;">Valider</button>
        <button id="btnRetourForm" style="margin:5px;">Retour</button>
      </div>
    </div>

    <!-- ‚úÖ LIS ELEVE -->
    <div id="listeContainer" class="no-print">
      <table id="listeBulletin">
        <thead>
          <tr>
            <th>Code √âl√®ve</th>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th>Classe</th>
            <th>P√©riode</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tbodyBulletins">
          <!-- Rempli pa JS -->
        </tbody>
      </table>
    </div>

    <!-- ‚úÖ Z√íN POU AFICHE BULLETIN AN -->
    <div id="bulletinPrintArea" style="display:none;"></div>
  </div>
</div>

<script>
  // ===== Inactivit√© =====
  let inactivityTimer;
  function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      fetch('/api/logout/', { method: 'GET', credentials: 'same-origin' }).finally(() => {
        Swal.fire({
          title: 'Session expir√©e',
          text: 'Vous avez √©t√© d√©connect√© automatiquement pour inactivit√©.',
          icon: 'warning',
          confirmButtonText: 'OK',
          allowOutsideClick: false,
          allowEscapeKey: false
        }).then(() => {
          window.location.href = '/connexion/';
        });
      });
    }, 2 * 60 * 1000);
  }
  ['mousemove','keydown','scroll','click'].forEach(ev => window.addEventListener(ev, resetInactivityTimer));
  resetInactivityTimer();

  // ===== Profil =====
  const toggle = document.getElementById('profileDropdownToggle');
  const dropdown = document.getElementById('profileDropdown');
  if (toggle && dropdown) {
    toggle.addEventListener('click', e => {
      e.stopPropagation();
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', () => dropdown.style.display = 'none');
  }

  // ===== √âl√©ments =====
  const btnAfficherFormulaire = document.getElementById('btnAfficherFormulaire');
  const formulairePage = document.getElementById('formulairePage');
  const inputCodeForm = document.getElementById('inputCodeForm');
  const btnValiderForm = document.getElementById('btnValiderForm');
  const btnRetourForm = document.getElementById('btnRetourForm');
  const listeContainer = document.getElementById('listeContainer');
  const bulletinPrintArea = document.getElementById('bulletinPrintArea');
  const tbody = document.getElementById('tbodyBulletins');

  // ===== Chaje lis eleve =====
  async function chargerListeElevesPourBulletin() {
    try {
      const res = await fetch('/bulletin/api/liste_eleves/');
      const eleves = await res.json();
      if (eleves.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">Aucun bulletin enregistr√©</td></tr>`;
        return;
      }
      tbody.innerHTML = eleves.map(e => `
        <tr>
          <td>${e.code}</td>
          <td>${e.nom}</td>
          <td>${e.prenom}</td>
          <td>${e.classe}</td>
          <td>${e.periode || 'N/A'}</td>
          <td><button class="btnRechercher">Afficher</button></td>
        </tr>
      `).join('');
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center">Erreur de chargement</td></tr>`;
    }
  }

  // ===== Fonksyon pou anrejistre =====
  async function enregistrerBulletin(code, periode) {
    try {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                        document.cookie.replace(/(?:(?:^|.*;\s*)csrftoken\s*=\s*([^;]*).*$)|^.*$/, "$1");
      const res = await fetch('/bulletin/api/enregistrer/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ code, periode })
      });
      const result = await res.json();
      if (res.ok) {
        return { success: true, message: '‚úÖ Bulletin enregistr√© avec succ√®s !' };
      } else {
        throw new Error(result.erreur || '√âchec de l‚Äôenregistrement');
      }
    } catch (err) {
      console.error(err);
      return { success: false, message: '‚ùå Erreur : ' + err.message };
    }
  }

  // ===== Afiche bulletin =====
  async function chargerEtAfficherBulletin(code) {
    try {
      const res = await fetch(`/bulletin/api/bulletin/?code=${encodeURIComponent(code)}`);
      const data = await res.json();
      if (!res.ok) throw new Error(data.erreur || "√âl√®ve non trouv√©");

      const { eleve, notes, total_pondere, moyenne, mention } = data;
      const lignes = notes.map(n => 
        `<tr><td>${n.matiere}</td><td>${n.coef}</td><td>${n.note}</td><td>${n.pondere.toFixed(2)}</td></tr>`
      ).join('');

      bulletinPrintArea.innerHTML = `
        <img src="/static/icone/CBA.png" alt="Logo" id="bulletinLogo" style="max-width:150px; display:block; margin:0 auto 10px;">
        <h3 style="text-align:center;">Bulletin de ${eleve.prenom} ${eleve.nom} | Classe: ${eleve.classe}</h3>
        <table style="width:100%; border-collapse:collapse; margin:15px 0;">
          <thead style="background-color:#0d6efd; color:white;">
            <tr><th>Mati√®re</th><th>Coef</th><th>Note</th><th>Pond√©r√©e</th></tr>
          </thead>
          <tbody>${lignes}</tbody>
          <tfoot>
            <tr><td colspan="3">Total pond√©r√©</td><td>${total_pondere.toFixed(2)}</td></tr>
            <tr><td colspan="3">Moyenne</td><td>${moyenne} (${mention})</td></tr>
          </tfoot>
        </table>
        
        <!-- ‚úÖ Cachet / Siyati -->
        <div style="text-align:center; margin:20px 0;">
          <img src="/static/image/cachet.png" alt="Cachet" id="bulletinCachet" style="max-width:150px; display:none;">
          <div id="cachetPlaceholder" style="margin-top:10px; color:#666;">Aucun cachet s√©lectionn√©</div>
          <input type="file" id="cachetInput" accept="image/*" style="display:none;">
          <button id="btnChoisirCachet" style="margin-top:10px;">üìé Choisir Cachet / Siyati</button>
        </div>

        <!-- ‚úÖ Bouton aksyon -->
        <div style="text-align:center; margin-top:20px;" class="no-print">
          <button id="btnEnregistrerBulletin" data-code="${eleve.code}" data-periode="${data.periode || '1er_trimestre'}">
            üíæ Enregistrer dans la base
          </button>
          <button id="btnImprimerBulletin" style="display:none;">üñ®Ô∏è Imprimer / PDF</button>
          <button id="btnRetourDuBulletin">‚¨ÖÔ∏è Retour √† la liste</button>
        </div>
      `;

      // Kache tout l√≤t bagay
      listeContainer.style.display = 'none';
      formulairePage.style.display = 'none';
      document.querySelector('.top-right').style.display = 'none';
      document.querySelector('h2').style.display = 'none';
      bulletinPrintArea.style.display = 'block';

      // ===== EVENMAN =====
      document.getElementById('btnChoisirCachet').addEventListener('click', () => {
        document.getElementById('cachetInput').click();
      });

      document.getElementById('cachetInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = document.getElementById('bulletinCachet');
            img.src = event.target.result;
            img.style.display = 'block';
            document.getElementById('cachetPlaceholder').style.display = 'none';
            document.getElementById('btnImprimerBulletin').style.display = 'inline-block';
          };
          reader.readAsDataURL(file);
        }
      });

      document.getElementById('btnEnregistrerBulletin').addEventListener('click', async () => {
        const btn = document.getElementById('btnEnregistrerBulletin');
        const result = await enregistrerBulletin(btn.dataset.code, btn.dataset.periode);
        alert(result.message);
      });

      document.getElementById('btnImprimerBulletin').addEventListener('click', () => {
        window.print();
      });

      document.getElementById('btnRetourDuBulletin').addEventListener('click', () => {
        bulletinPrintArea.innerHTML = '';
        bulletinPrintArea.style.display = 'none';
        listeContainer.style.display = 'block';
        document.querySelector('.top-right').style.display = 'inline-block';
        document.querySelector('h2').style.display = 'block';
      });

    } catch (err) {
      alert("Erreur : " + err.message);
    }
  }

  // ===== √âv√©nements =====
  btnAfficherFormulaire.addEventListener('click', () => {
    formulairePage.style.display = 'block';
    listeContainer.style.display = 'none';
    document.querySelector('h2').style.display = 'none';
  });

  btnRetourForm.addEventListener('click', () => {
    formulairePage.style.display = 'none';
    listeContainer.style.display = 'block';
    document.querySelector('h2').style.display = 'block';
  });

  btnValiderForm.addEventListener('click', () => {
    const code = inputCodeForm.value.trim();
    if (!code) {
      alert("Veuillez entrer le code de l'√©l√®ve.");
      return;
    }
    chargerEtAfficherBulletin(code);
  });

  tbody.addEventListener('click', (e) => {
    if (e.target.classList.contains('btnRechercher')) {
      const row = e.target.closest('tr');
      const code = row.children[0].textContent.trim();
      if (code) chargerEtAfficherBulletin(code);
    }
  });

  chargerListeElevesPourBulletin();

  document.getElementById('searchBulletinInput')?.addEventListener('input', function() {
    const term = this.value.toLowerCase();
    document.querySelectorAll('#tbodyBulletins tr').forEach(row => {
      row.style.display = term && !row.textContent.toLowerCase().includes(term) ? 'none' : '';
    });
  });
</script>

<script src="{% static 'js/dropdown.js' %}"></script>
<script src="{% static 'js/charts.js' %}"></script>
</body>
</html>