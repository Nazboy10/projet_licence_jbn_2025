
{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossier Eleve</title>
    <link rel="icon" type="image/png" href="{% static 'icone/CBA.png' %}">
      <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <!-- CSS Custom -->
     <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- <link rel="stylesheet" href="{% static '/css/Dossier_Eleves.css' %}"> -->
        <link rel="stylesheet" href="{% static 'app_eleve/css/eleve.css' %}">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <div class="sidebar">
       <div class="logo">
     <img src="{% static '/icone/CBA.png' %}" alt="Logo SGCBA" class="logo-img">  
    <span>SGCBA</span>
</div>

       <nav>
  <ul>
    <li id="menu-dashboard"><a href="{% url 'tableau_de_bord' %}"><i class="fas fa-th-large"></i>TABLEAU DE BORD</a></li>
    <li id="menu-inscription"><a href="{% url 'inscription' %}"><i class="fa-solid fa-notes-medical"></i> Inscription</a></li>
    <li id="menu-eleve"><a href="{% url 'eleve' %}"class="active"><i class="fa-solid fa-user-tie"></i> Eleve</a></li>
    <li id="menu-presence"><a href="{% url 'presence' %}"><i class="fas fa-chalkboard-teacher"></i> Presence</a></li>
    <li id="menu-note"><a href="{% url 'note' %}"><i class='bx bx-note'></i> Note</a></li>
    <li id="menu-bulletin"><a href="{% url 'bulletin' %}"><i class="fa-solid fa-square-poll-horizontal"></i> Bulletin</a></li>
     <li id="menu-classe"><a href="{% url 'classe' %}"><i class="fa-solid fa-square-poll-horizontal"></i> Classe</a></li>
    <li id="menu-utilisateur"><a href="{% url 'utilisateurs' %}"><i class="fa-solid fa-user"></i> Utilisateur</a></li>
    <li id="menu-parametre"><a href="{% url 'parametre' %}"><i class="fa-solid fa-gear"></i> Parametres</a></li>
  </ul>
</nav>
       
    </div>

    <div class="main-content">
        <div class="header">
            <h1>DOSSIER ELEVE</h1>
            <div class="search-profile">
               <div class="search-bar" style="display: flex; align-items: center; gap: 8px;">
    <i class="fas fa-search" id="icone" style="color: #6c757d;"></i>
    <input 
        type="text" 
        id="searchInput"
        placeholder="      Rechercher un √©l√®ve" 
        value="{{ search_query }}"
        style="padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; width: 300px;"
    >
</div>
               <div class="profile">
    <i class="fas fa-bell notification-icon"></i>
    <div class="user-avatar" id="profileDropdownToggle">
    <img src="{{ user_photo|default:'/static/image/pro.png' }}" alt="Profil">
</div>

    <!-- Dropdown menu -->
    <div class="profile-dropdown" id="profileDropdown">
        <ul>
             <li><a href="{% url 'logout' %}">D√©connecter</a></li>
        </ul>
    </div>
</div>
 </div>
        </div>


  <div class="container">
   

    <!-- Bouton Ajouter -->
    <!-- <div class="mb-3 text-end">
      <button id="btnShowForm" class="btn btn-primary btn-custom">Ajouter</button>
    </div> -->

    <!-- Formulaire (modal) -->
    <div id="formModal" class="modal-overlay">
      <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <h4 class="mb-3">Dossier √©l√®ve</h4>
        <form id="inscriptionForm">
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Code √©l√®ve</label>
              <input type="text" class="form-control" placeholder="Code" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Nom</label>
              <input type="text" class="form-control" placeholder="Nom" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Pr√©nom</label>
              <input type="text" class="form-control" placeholder="Pr√©nom" required>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Sexe</label>
              <select class="form-select">
                <option>Masculin</option>
                <option>F√©minin</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label">Adresse</label>
              <input type="text" class="form-control" placeholder="Adresse" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Classe</label>
              <input type="text" class="form-control" placeholder="Classe" required>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">T√©l√©phone</label>
              <input type="text" class="form-control" placeholder="T√©l√©phone" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Nom Tuteur</label>
              <input type="text" class="form-control" placeholder="Nom Tuteur" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">T√©l√©phone Tuteur</label>
              <input type="text" class="form-control" placeholder="T√©l√©phone Tuteur" required>
            </div>
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-custom btn-ajouter">Ajouter</button>
            {% comment %} <button type="submit" class="btn btn-success btn-custom">Ajouter</button> {% endcomment %}
            <button type="button" id="cancelForm" class="btn btn-secondary btn-custom">Fermer</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Options affichage -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <label>Afficher 
          <select class="form-select d-inline w-auto">
            <option>10</option>
            <option>25</option>
            <option>50</option>
          </select> 
          Dossier Eleve
        </label>
      </div>
    </div>
  <br>
    <!-- Table -->
    <!-- Table -->
<div class="table-responsive">
  <table class="table table-bordered table-striped" id="tableEleves">
    <thead class="table-header-blue">
      <tr>
        <th>Photo</th>
        <th>Code</th>
        <th>Nom</th>
        <th>Pr√©nom</th>
        <th>Classe</th>
        <th>T√©l√©phone</th>
        <th>Statut</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for e in eleves %}
      <tr>
        <td>
          {% if e.photo %}
            <img src="{{ e.photo.url }}" alt="Photo {{ e.nom }}" width="40" height="40" style="object-fit: cover; border-radius: 50%;">
          {% else %}
            <img src="{% static 'image/pro.png' %}" alt="Par d√©faut" width="40" height="40" style="object-fit: cover; border-radius: 50%;">
          {% endif %}
        </td>
        <td>{{ e.code_eleve }}</td>
        <td>{{ e.nom }}</td>
        <td>{{ e.prenom }}</td>
        <td>{{ e.classe }}</td>
        <td>{{ e.telephone }}</td>
        <td>
          {% if e.actif %}
            <span class="badge bg-success">Actif</span>
          {% else %}
            <span class="badge bg-danger">Inactif</span>
          {% endif %}
        </td>
        <td class="text-center">

        <!-- ‚úèÔ∏è Modifier -->
<button class="btn btn-sm btn-warning" title="Modifier" onclick="chargerModifier({{ e.id }})">
  <i class="bi bi-pencil"></i>
</button>

          <!-- üëÅÔ∏è Ic√¥ne pour voir les d√©tails -->
          <button class="btn btn-sm btn-outline-primary" title="Voir d√©tails" onclick="voirDetails({{ e.id }})">
            <i class="bi bi-eye"></i>
          </button>

          <!-- üîÅ Activer/D√©sactiver -->
          {% if e.actif %}
            <button class="btn btn-sm btn-outline-danger" onclick="toggleActif({{ e.id }}, false)" title="D√©sactiver">
              <i class="bi bi-x-circle"></i>
            </button>
          {% else %}
            <button class="btn btn-sm btn-outline-success" onclick="toggleActif({{ e.id }}, true)" title="Activer">
              <i class="bi bi-check-circle"></i>
            </button>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8" class="text-center">Aucun √©l√®ve enregistr√©.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
  </div>

    

   <!-- Modal Modifier √âl√®ve -->
<div id="modalModifier" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 700px; width: 90%;">
    <span id="closeModifier" class="close">&times;</span>
    <h4 class="mb-3">Modifier l'√©l√®ve</h4>
    <form id="formModifier">
      <input type="hidden" id="eleveId" name="id">

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Nom</label>
          <input type="text" id="modNom" name="nom" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Pr√©nom</label>
          <input type="text" id="modPrenom" name="prenom" class="form-control" required>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Sexe</label>
          <select id="modSexe" name="sexe" class="form-select" required>
            <option value="Masculin">Masculin</option>
            <option value="F√©minin">F√©minin</option>
          </select>
        </div>
        <div class="col-md-8">
          <label class="form-label">Adresse</label>
          <input type="text" id="modAdresse" name="adresse" class="form-control" required>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Date de naissance</label>
          <input type="date" id="modDateNaiss" name="date_naissance" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Classe</label>
          <input type="text" id="modClasse" name="classe" class="form-control" required>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">T√©l√©phone</label>
          <input type="text" id="modTelephone" name="telephone" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Email</label>
          <input type="email" id="modEmail" name="email" class="form-control">
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Nom Tuteur</label>
          <input type="text" id="modNomTuteur" name="nom_tuteur" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">T√©l√©phone Tuteur</label>
          <input type="text" id="modTelTuteur" name="telephone_tuteur" class="form-control" required>
        </div>
      </div>

      <div class="text-end">
        <button type="submit" class="btn btn-warning">Enregistrer</button>
        <button type="button" id="cancelModifier" class="btn btn-secondary">Annuler</button>
      </div>
    </form>
  </div>
</div>







  <!-- Modal D√©tails √âl√®ve -->
<div id="modalDetails" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 600px; width: 90%;">
    <span id="closeDetails" class="close">&times;</span>
    <h4>D√©tails de l'√©l√®ve</h4>
    <div id="detailsContent"></div>
    <div class="text-end mt-3">
      <button id="closeDetailsBtn" class="btn btn-secondary">Fermer</button>
    </div>
  </div>
</div>

  <!-- JS -->
  <script src="{% static 'app_eleve/js/eleve.js' %}"></script>
  <script src="{% static 'js/charts.js' %}"></script>
  <script src="{% static 'js/role-control.js' %}"></script>







<script>

function getCSRFToken() {
  return document.cookie.split(";")
    .find(c => c.trim().startsWith("csrftoken="))
    ?.split("=")[1];
}

// ‚úÖ Fonction toggleActif (GLOBALE ‚Üí accessible depuis onclick)
function toggleActif(id, actif) {
  const action = actif ? 'activer' : 'd√©sactiver';
  Swal.fire({
    title: `Confirmer ${action} ?`,
    text: "L'√©l√®ve sera " + (actif ? "r√©activ√©" : "d√©sactiv√©") + ".",
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Oui',
    cancelButtonText: 'Annuler'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/eleve/toggle-actif/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ actif: actif })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          Swal.fire("Erreur", "Impossible de modifier le statut.", "error");
        }
      })
      .catch(err => {
        console.error("Erreur r√©seau:", err);
        Swal.fire("Erreur", "Probl√®me de connexion au serveur.", "error");
      });
    }
  });
}

// ‚úÖ fonction rechercher
document.getElementById('searchInput').addEventListener('input', function() {
    const searchValue = this.value.trim();
    
    // Filtrer les lignes du tableau en temps r√©el
    const rows = document.querySelectorAll('#tableEleves tbody tr');
    let found = false;
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (searchValue === '' || text.includes(searchValue.toLowerCase())) {
            row.style.display = '';
            found = true;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Message si aucun r√©sultat
    const noResult = document.getElementById('noResult');
    if (searchValue !== '' && !found) {
        if (!noResult) {
            const message = document.createElement('tr');
            message.id = 'noResult';
            message.innerHTML = `<td colspan="8" class="text-center text-muted">Aucun √©l√®ve trouv√©</td>`;
            document.querySelector('#tableEleves tbody').appendChild(message);
        }
    } else if (noResult) {
        noResult.remove();
    }
});



function voirDetails(id) {
  fetch(`/eleve/details/${id}/`)
    .then(response => response.json())
    .then(e => {
      let content = `
        <div class="row">
          <div class="col-4 text-center">
            <img src="${e.photo_url || '{% static 'image/pro.png' %}'}" width="100" class="rounded-circle">
          </div>
          <div class="col-8">
            <p><strong>Code :</strong> ${e.code_eleve}</p>
            <p><strong>Nom :</strong> ${e.nom} ${e.prenom}</p>
            <p><strong>Sexe :</strong> ${e.sexe || '‚Äî'}</p>
            <p><strong>Adresse :</strong> ${e.adresse || '‚Äî'}</p>
            <p><strong>Classe :</strong> ${e.classe}</p>
            <p><strong>T√©l√©phone :</strong> ${e.telephone || '‚Äî'}</p>
            <p><strong>Nom Tuteur :</strong> ${e.nom_tuteur || '‚Äî'}</p>
            <p><strong>T√©l. Tuteur :</strong> ${e.telephone_tuteur || '‚Äî'}</p>
            <p><strong>Email :</strong> ${e.email || '‚Äî'}</p>
            <p><strong>Date naissance :</strong> ${e.date_naissance || '‚Äî'}</p>
            <p><strong>Ann√©e acad√©mique :</strong> ${e.annee_academique || '‚Äî'}</p>
             <p><strong>Lieu de Naissance :</strong> ${e.lieu_naissance || '‚Äî'}</p>

            <p><strong>Statut :</strong> ${e.actif ? '<span class="badge bg-success">Actif</span>' : '<span class="badge bg-danger">Inactif</span>'}</p>
          </div>
        </div>
      `;
      document.getElementById('detailsContent').innerHTML = content;
      document.getElementById('modalDetails').style.display = 'flex';
    })
    .catch(err => {
      Swal.fire("Erreur", "Impossible de charger les d√©tails.", "error");
    });
}

// Fermer la modale
document.getElementById('closeDetails')?.addEventListener('click', () => {
  document.getElementById('modalDetails').style.display = 'none';
});
document.getElementById('closeDetailsBtn')?.addEventListener('click', () => {
  document.getElementById('modalDetails').style.display = 'none';
});



 // Charger les donn√©es dans le formulaire de modification
function chargerModifier(id) {
  fetch(`/eleve/details/${id}/`)
    .then(response => response.json())
    .then(e => {
      document.getElementById('eleveId').value = e.id;
      document.getElementById('modNom').value = e.nom;
      document.getElementById('modPrenom').value = e.prenom;
      document.getElementById('modSexe').value = e.sexe || 'Masculin';
      document.getElementById('modAdresse').value = e.adresse || '';
      document.getElementById('modClasse').value = e.classe || '';
      document.getElementById('modTelephone').value = e.telephone || '';
      document.getElementById('modEmail').value = e.email || '';
      document.getElementById('modNomTuteur').value = e.nom_tuteur || '';
     document.getElementById('modTelTuteur').value = e.telephone_tuteur || '';
      document.getElementById('modDateNaiss').value = e.date_naissance_raw || ''; // on va l‚Äôajuster dans la vue

      document.getElementById('modalModifier').style.display = 'flex';
    })
    .catch(err => {
      Swal.fire("Erreur", "Impossible de charger les donn√©es pour modification.", "error");
    });
}

// G√©rer la soumission du formulaire de modification
document.getElementById('formModifier')?.addEventListener('submit', function(e) {
  e.preventDefault();
  const id = document.getElementById('eleveId').value;
  const formData = new FormData(this);

  fetch(`/eleve/modifier/${id}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      Swal.fire("Succ√®s", "√âl√®ve mis √† jour avec succ√®s !", "success");
      document.getElementById('modalModifier').style.display = 'none';
      location.reload(); // ou mettre √† jour dynamiquement
    } else {
      Swal.fire("Erreur", data.error || "Erreur lors de la modification.", "error");
    }
  })
  .catch(err => {
    console.error(err);
    Swal.fire("Erreur", "Probl√®me de connexion au serveur.", "error");
  });
});

// Fermer la modale de modification
document.getElementById('closeModifier')?.addEventListener('click', () => {
  document.getElementById('modalModifier').style.display = 'none';
});
document.getElementById('cancelModifier')?.addEventListener('click', () => {
  document.getElementById('modalModifier').style.display = 'none';
});




    let inactivityTimer;

    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
            fetch('/api/logout/', {
                method: 'GET',
                credentials: 'same-origin'
            }).finally(() => {
                // ‚úÖ Remplace alert() par SweetAlert2
                Swal.fire({
                    title: 'Session expir√©e',
                    text: 'Vous avez √©t√© d√©connect√© automatiquement pour inactivit√©.',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then(() => {
                    window.location.href = '/connexion/';
                });
            });
        },2 * 60 * 1000); // 2 minutes d'inactivit√©
    }

    resetInactivityTimer();

    window.addEventListener('mousemove', resetInactivityTimer);
    window.addEventListener('keydown', resetInactivityTimer);
    window.addEventListener('scroll', resetInactivityTimer);
    window.addEventListener('click', resetInactivityTimer);






</script>


</body>
</html>